name: E2E - Locust on kind

on:
  push:
    branches: [ "dev", "pipelines"  ]
  pull_request:
    branches: [ "dev","pipelines" ]
  workflow_dispatch: {}

jobs:
  e2e-locust:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Locust deps
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install -r tests/locust/requirements.txt
          python -c "import locust, sys; print('Locust:', locust.__version__)"

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: latest

      - name: Install kind
        uses: helm/kind-action@v1.10.0
        with:
          version: v0.23.0

      - name: Create kind cluster
        run: |
          kind create cluster --name dev-e2e --wait 120s
          kubectl version --client -o yaml
          kubectl get nodes -o wide

      - name: Apply manifests (YAML)
        run: |
          kubectl apply -f kubernetes
          kubectl get ns ecommerce

      - name: Wait for deployments Ready
        run: |
          set -e
          kubectl -n ecommerce wait --for=condition=available --timeout=360s deployment --all
          kubectl -n ecommerce wait --for=condition=ready --timeout=360s pod --all
          kubectl -n ecommerce get pods -o wide

      - name: Port-forward services to localhost
        run: |
          set -e
          pod_of() { kubectl -n "$1" get pod -l app="$2" -o jsonpath='{.items[0].metadata.name}'; }

          P_PRODUCT=$(pod_of ecommerce product-service)
          P_USER=$(pod_of ecommerce user-service)
          P_SHIP=$(pod_of ecommerce shipping-service)
          P_PAY=$(pod_of ecommerce payment-service)
          P_ORDER=$(pod_of ecommerce order-service)
          P_FAV=$(pod_of ecommerce favourite-service)

          echo "PF -> product-service: $P_PRODUCT, user-service: $P_USER, shipping: $P_SHIP, payment: $P_PAY, order: $P_ORDER, favourite: $P_FAV"

          nohup kubectl -n ecommerce port-forward pod/$P_PRODUCT 8500:8500 >/dev/null 2>&1 & echo $! > pf_product.pid
          nohup kubectl -n ecommerce port-forward pod/$P_USER 8700:8700   >/dev/null 2>&1 & echo $! > pf_user.pid
          nohup kubectl -n ecommerce port-forward pod/$P_SHIP 8600:8600   >/dev/null 2>&1 & echo $! > pf_shipping.pid
          nohup kubectl -n ecommerce port-forward pod/$P_PAY 8400:8400    >/dev/null 2>&1 & echo $! > pf_payment.pid
          nohup kubectl -n ecommerce port-forward pod/$P_ORDER 8300:8300  >/dev/null 2>&1 & echo $! > pf_order.pid
          nohup kubectl -n ecommerce port-forward pod/$P_FAV 8800:8800    >/dev/null 2>&1 & echo $! > pf_favourite.pid

          sleep 30

      - name: Warm-up and readiness checks (retry)
        run: |
          set -e
          retry() { for i in $(seq 1 24); do curl -fsS "$1" && echo "\nOK: $1" && return 0; echo "Retry $i: $1"; sleep 5; done; return 1; }

          if ! retry http://localhost:8500/product-service/api/products; then
            echo "DIAGNOSTICO: estado de product-service";
            kubectl -n ecommerce get svc product-service -o yaml || true
            kubectl -n ecommerce get endpoints product-service -o wide || true
            kubectl -n ecommerce get pod -l app=product-service -o wide || true
            P_PRODUCT=$(kubectl -n ecommerce get pod -l app=product-service -o jsonpath='{.items[0].metadata.name}' || true)
            [ -n "$P_PRODUCT" ] && kubectl -n ecommerce logs "$P_PRODUCT" --tail=200 || true
            exit 1
          fi

          if ! retry http://localhost:8700/user-service/api/users; then
            echo "DIAGNOSTICO: estado de user-service";
            kubectl -n ecommerce get svc user-service -o yaml || true
            kubectl -n ecommerce get endpoints user-service -o wide || true
            kubectl -n ecommerce get pod -l app=user-service -o wide || true
            P_USER=$(kubectl -n ecommerce get pod -l app=user-service -o jsonpath='{.items[0].metadata.name}' || true)
            [ -n "$P_USER" ] && kubectl -n ecommerce logs "$P_USER" --tail=200 || true
            exit 1
          fi

          curl -fsS http://localhost:8600/shipping-service/api/shippings || true
          curl -fsS http://localhost:8400/payment-service/api/payments || true
          curl -fsS http://localhost:8300/order-service/api/orders || true
          curl -fsS http://localhost:8800/favourite-service/api/favourites || true

      - name: Run Locust (headless)
        env:
          PRODUCT_URL: http://localhost:8500/product-service/api/products
          USER_URL: http://localhost:8700/user-service/api/users
          SHIPPING_URL: http://localhost:8600/shipping-service/api/shippings
          PAYMENT_URL: http://localhost:8400/payment-service/api/payments
          ORDER_URL: http://localhost:8300/order-service/api/orders
          FAVOURITE_URL: http://localhost:8800/favourite-service/api/favourites
          BASE_HOST: http://localhost
        run: |
          python -m locust -f tests/locust/locustfile.py --host http://localhost --headless -u 50 -r 10 -t 1m --html locust-report.html --csv locust-results

      - name: Upload Locust report
        uses: actions/upload-artifact@v4
        with:
          name: locust-report
          path: |
            locust-report.html
            locust-results*.csv

      - name: Teardown
        if: always()
        run: |
          set +e
          for pid in pf_*.pid; do [ -f "$pid" ] && kill $(cat "$pid") 2>/dev/null || true; done
          kind delete cluster --name dev-e2e
