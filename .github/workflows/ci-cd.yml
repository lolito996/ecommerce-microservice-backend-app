name: Build and Deploy to Registry

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      REGISTRY: ghcr.io/${{ github.repository_owner }}
      TAG: latest

    steps:
      # ðŸ§© Paso 1: Clonar el repositorio
      - name: Checkout code
        uses: actions/checkout@v4

      # ðŸ§© Paso 2: Configurar Docker Buildx (necesario para multi-stage build)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ðŸ§© Paso 3: Corregir los Dockerfile para forzar el uso de Docker Hub
      # Esto evita el error "openjdk:11 not found"
      - name: Fix Dockerfiles base image path
        run: |
          find . -name "Dockerfile" -exec sed -i 's|^FROM openjdk:11|FROM docker.io/openjdk:11|' {} \;

      # ðŸ§© Paso 4: Login en Docker Hub (para descargar imÃ¡genes base)
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}

      # ðŸ§© Paso 5: Build de todas las imÃ¡genes (no hace push aÃºn)
      - name: Build all microservice images
        run: |
          docker build -t api-gateway:${{ env.TAG }} -f ./api-gateway/Dockerfile ./api-gateway
          docker build -t cloud-config:${{ env.TAG }} -f ./cloud-config/Dockerfile ./cloud-config
          docker build -t service-discovery:${{ env.TAG }} -f ./service-discovery/Dockerfile ./service-discovery
          docker build -t user-service:${{ env.TAG }} -f ./user-service/Dockerfile ./user-service
          docker build -t order-service:${{ env.TAG }} -f ./order-service/Dockerfile ./order-service
          docker build -t payment-service:${{ env.TAG }} -f ./payment-service/Dockerfile ./payment-service
          docker build -t shipping-service:${{ env.TAG }} -f ./shipping-service/Dockerfile ./shipping-service
          docker build -t favourite-service:${{ env.TAG }} -f ./favourite-service/Dockerfile ./favourite-service
          docker build -t proxy-client:${{ env.TAG }} -f ./proxy-client/Dockerfile ./proxy-client

      # ðŸ§© Paso 6: Login en el registry privado (para subir imÃ¡genes)
      - name: Login to Private Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}

      # ðŸ§© Paso 7: Push de las imÃ¡genes al registry
      - name: Push images to Private Registry
        run: |
          for service in api-gateway cloud-config service-discovery user-service order-service payment-service shipping-service favourite-service proxy-client; do
            docker tag $service:${{ env.TAG }} ${{ env.REGISTRY }}/$service:${{ env.TAG }}
            docker push ${{ env.REGISTRY }}/$service:${{ env.TAG }}
          done
