name: CI/CD Monorepo Microservicios

on:
  push:
    branches: [ dev, main ]
  pull_request:
    branches: [ dev, main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      REGISTRY: ${{ secrets.DOCKER_REGISTRY }}
      KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
      NAMESPACE: ecommerce
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3

      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login Docker
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}

      # Build JAR de todos los microservicios Java antes de construir la imagen
      - name: Build api-gateway JAR
        run: |
          cd api-gateway
          ./mvnw clean package -DskipTests

      - name: Build proxy-client JAR
        run: |
          cd proxy-client
          ./mvnw clean package -DskipTests

      - name: Build order-service JAR
        run: |
          cd order-service
          ./mvnw clean package -DskipTests

      - name: Build payment-service JAR
        run: |
          cd payment-service
          ./mvnw clean package -DskipTests

      - name: Build product-service JAR
        run: |
          cd product-service
          ./mvnw clean package -DskipTests

      - name: Build user-service JAR
        run: |
          cd user-service
          ./mvnw clean package -DskipTests

      - name: Build favourite-service JAR
        run: |
          cd favourite-service
          ./mvnw clean package -DskipTests

      - name: Build shipping-service JAR
        run: |
          cd shipping-service
          ./mvnw clean package -DskipTests

      # Build JAR de servicios core
      - name: Build cloud-config JAR
        run: |
          cd cloud-config
          ./mvnw clean package -DskipTests

      - name: Build service-discovery JAR
        run: |
          cd service-discovery
          ./mvnw clean package -DskipTests

      # Build & Push de todos los microservicios
      - name: Build & Push api-gateway
        uses: docker/build-push-action@v5
        with:
          context: ./api-gateway
          file: ./api-gateway/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/alejomunoz/api-gateway-ecommerce-boot:dev

      - name: Build & Push proxy-client
        uses: docker/build-push-action@v5
        with:
          context: ./proxy-client
          file: ./proxy-client/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/alejomunoz/proxy-client-ecommerce-boot:dev

      - name: Build & Push order-service
        uses: docker/build-push-action@v5
        with:
          context: ./order-service
          file: ./order-service/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/alejomunoz/order-service-ecommerce-boot:dev

      - name: Build & Push payment-service
        uses: docker/build-push-action@v5
        with:
          context: ./payment-service
          file: ./payment-service/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/alejomunoz/payment-service-ecommerce-boot:dev

      - name: Build & Push product-service
        uses: docker/build-push-action@v5
        with:
          context: ./product-service
          file: ./product-service/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/alejomunoz/product-service-ecommerce-boot:dev

      - name: Build & Push user-service
        uses: docker/build-push-action@v5
        with:
          context: ./user-service
          file: ./user-service/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/alejomunoz/user-service-ecommerce-boot:dev

      - name: Build & Push favourite-service
        uses: docker/build-push-action@v5
        with:
          context: ./favourite-service
          file: ./favourite-service/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/alejomunoz/favourite-service-ecommerce-boot:dev

      - name: Build & Push shipping-service
        uses: docker/build-push-action@v5
        with:
          context: ./shipping-service
          file: ./shipping-service/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/alejomunoz/shipping-service-ecommerce-boot:dev

      # Build & Push servicios core
      - name: Build & Push cloud-config
        uses: docker/build-push-action@v5
        with:
          context: ./cloud-config
          file: ./cloud-config/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/alejomunoz/cloud-config-ecommerce-boot:dev

      - name: Build & Push service-discovery
        uses: docker/build-push-action@v5
        with:
          context: ./service-discovery
          file: ./service-discovery/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/alejomunoz/service-discovery-ecommerce-boot:dev