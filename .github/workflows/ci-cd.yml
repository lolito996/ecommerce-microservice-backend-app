name: CI/CD Monorepo Microservicios

on:
  push:
    branches: [ dev, master, pipelines ]
  pull_request:
    branches: [ dev, master, pipelines ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      REGISTRY: ${{ secrets.DOCKER_REGISTRY }}
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3

      - name: Setup Java 11
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Make mvnw executable
        run: chmod +x mvnw

      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login Docker
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}

      # Build JAR de todos los microservicios y core
      - name: Build todos los JAR
        run: |
          cd api-gateway && ./mvnw clean package -DskipTests && cd ..
          cd proxy-client && ./mvnw clean package -DskipTests && cd ..
          cd order-service && ./mvnw clean package -DskipTests && cd ..
          cd payment-service && ./mvnw clean package -DskipTests && cd ..
          cd product-service && ./mvnw clean package -DskipTests && cd ..
          cd user-service && ./mvnw clean package -DskipTests && cd ..
          cd favourite-service && ./mvnw clean package -DskipTests && cd ..
          cd shipping-service && ./mvnw clean package -DskipTests && cd ..
          cd cloud-config && ./mvnw clean package -DskipTests && cd ..
          cd service-discovery && ./mvnw clean package -DskipTests && cd ..

      # Build & Push de todos los microservicios y core
      - name: Build & Push api-gateway
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./api-gateway/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/alejomunoz/api-gateway-ecommerce-boot:0.1.0

      - name: Build & Push proxy-client
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./proxy-client/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/alejomunoz/proxy-client-ecommerce-boot:0.1.0

      - name: Build & Push order-service
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./order-service/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/alejomunoz/order-service-ecommerce-boot:0.1.0

      - name: Build & Push payment-service
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./payment-service/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/alejomunoz/payment-service-ecommerce-boot:0.1.0

      - name: Build & Push product-service
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./product-service/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/alejomunoz/product-service-ecommerce-boot:0.1.0

      - name: Build & Push user-service
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./user-service/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/alejomunoz/user-service-ecommerce-boot:0.1.0

      - name: Build & Push favourite-service
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./favourite-service/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/alejomunoz/favourite-service-ecommerce-boot:0.1.0

      - name: Build & Push shipping-service
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./shipping-service/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/alejomunoz/shipping-service-ecommerce-boot:0.1.0

      - name: Build & Push cloud-config
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./cloud-config/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/alejomunoz/cloud-config-ecommerce-boot:0.1.0

      - name: Build & Push service-discovery
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./service-discovery/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/alejomunoz/service-discovery-ecommerce-boot:0.1.0