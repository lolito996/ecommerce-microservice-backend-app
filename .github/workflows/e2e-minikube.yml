name: E2E Tests on Minikube

on:
  workflow_dispatch:
  push:
    branches: [ pipelines, main, master ]

jobs:
  e2e-on-minikube:
    name: Run E2E tests (Minikube)
    runs-on: self-hosted
    env:
      NAMESPACE: ecommerce
      K8S_MANIFEST: ./kubernetes
      LOAD_SCRIPT: ./load-images-minikube.bat

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Print environment (debug)
        shell: pwsh
        run: |
          docker --version
          minikube version
          kubectl version --client
          pwsh --version

      - name: Ensure Minikube is running
        shell: pwsh
        run: |
          $status = minikube status --format '{{.Host}}' 2>$null
          if ($status -ne 'Running') {
            Write-Host "Minikube not running. Starting..."
            minikube start
          } else {
            Write-Host "Minikube running"
          }

      - name: Load images into Minikube
        shell: pwsh
        run: |
          Write-Host "Running image loader: $env:LOAD_SCRIPT"
          & $env:LOAD_SCRIPT

      - name: Ensure namespace exists
        shell: pwsh
        run: |
          kubectl create namespace $env:NAMESPACE --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply Kubernetes manifests
        shell: pwsh
        run: |
          Write-Host "Applying manifests from $env:K8S_MANIFEST"
          kubectl apply -f $env:K8S_MANIFEST

      - name: Wait for deployments
        shell: pwsh
        run: |
          $deps = kubectl get deployments -n $env:NAMESPACE -o jsonpath="{.items[*].metadata.name}"
          foreach ($d in $deps.Split(' ')) {
            if ($d) { kubectl rollout status deployment/$d -n $env:NAMESPACE --timeout=3m }
          }

      - name: Setup JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Run E2E tests (Maven)
        shell: pwsh
        run: |
          mvn -f e2e-tests test -DskipUnit=false -DskipITs=false

      - name: Archive test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-reports
          path: e2e-tests/target/**/surefire-reports, e2e-tests/target/**/failsafe-reports

      - name: Show pods (final)
        shell: pwsh
        run: kubectl get pods -n $env:NAMESPACE -o wide
