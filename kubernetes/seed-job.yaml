apiVersion: batch/v1
kind: Job
metadata:
  name: seed-job
spec:
  template:
    spec:
      containers:
      - name: seeder
        image: bitnami/kubectl:1.23.0
        command:
        - sh
        - -c
        - |
          set -e
          echo 'Seeding test data...'
          # attempt to POST fixtures using curl; assume api-gateway is accessible in-cluster
          # read fixtures from a ConfigMap mounted at /fixtures if provided, otherwise use inline payloads
          cat <<'JSON' > /tmp/user1.json
          {"userId":1,"firstName":"John","lastName":"Doe","email":"john@example.com","phone":"1234567890"}
          JSON
          cat <<'JSON' > /tmp/product1.json
          {"productId":1,"productTitle":"Keyboard","sku":"KB-001","priceUnit":49.99,"quantity":100}
          JSON
          # try to call api-gateway service; namespace should be the same as the job
          for i in 1 2 3; do
            if curl -sS -X POST -H 'Content-Type: application/json' http://api-gateway:8080/api/users -d @/tmp/user1.json; then
              echo 'Seeded user'
              break
            fi
            sleep 2
          done
          for i in 1 2 3; do
            if curl -sS -X POST -H 'Content-Type: application/json' http://api-gateway:8080/api/products -d @/tmp/product1.json; then
              echo 'Seeded product'
              break
            fi
            sleep 2
          done
      restartPolicy: Never
  backoffLimit: 1
